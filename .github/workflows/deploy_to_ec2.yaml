name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Publish API
        run: dotnet publish -c Release -r linux-x64 --self-contained true -p:PublishReadyToRun=true -p:PublishSingleFile=true -o ./publish

      - name: Copy files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./publish/*"
          target: "/home/${{ secrets.USERNAME }}/app"
          strip_components: 1
          debug: true

      - name: Stop and Restart Service via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }} 
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Find and kill the process using port 443
            sudo fuser -k 443/tcp || echo "No process found on port 443"
            
            # 2. Navigate to the app directory
            cd /home/${{ secrets.USERNAME }}/app
            
            # 3. Ensure the binary is executable
            chmod +x ./deepdeepbimapi
            
            # 4. Run the app in the background (using sudo for port 443)
            # We use setsid or nohup to ensure the process survives the SSH session closing
            sudo nohup ./deepdeepbimapi --urls "https://0.0.0.0:443" > output.log 2>&1 &